SELECT COUNT(*) FROM `project-leducthinh-2024.DA04_K300.hack_data` LIMIT 1000 
-- 334

SELECT * FROM `project-leducthinh-2024.DA04_K300.hack_data` LIMIT 3 
  -- "Session_Connection_Time",
  -- "Bytes Transferred"
  -- "Kali_Trace_Used"
  -- "Servers_Corrupted"
  -- "Pages_Corrupted"
  -- "Location"
  -- "WPM_Typing_Speed"
  -- "Bytes_Transferred_New"



-- K=2 (giả định 2 hacker):
CREATE OR REPLACE MODEL `project-leducthinh-2024.DA04_K300.hack_data_clustering_2`
OPTIONS(MODEL_TYPE = 'kmeans',
        num_clusters = 2) 
AS
SELECT 
  Session_Connection_Time,
  Kali_Trace_Used,
  Servers_Corrupted,
  Pages_Corrupted,
  WPM_Typing_Speed,
  Bytes_Transferred_New
FROM `project-leducthinh-2024.DA04_K300.hack_data` 


-- Mean Squared Distance: 18007. >>> Khoảng cách này tương đối lớn, cho thấy sự phân cụm còn thiếu rõ ràng.

-- Cụm 1: 167 phiên.
-- Cụm 2: 167 phiên.
-- Hai cụm có số lượng phiên hoàn toàn cân bằng, phù hợp với giả định 2 hacker.


-- K=3 (giả định 3 hacker):
CREATE OR REPLACE MODEL `project-leducthinh-2024.DA04_K300.hack_data_clustering_3`
OPTIONS(MODEL_TYPE = 'kmeans',
        num_clusters = 3) 
AS
SELECT 
  Session_Connection_Time,
  Kali_Trace_Used,
  Servers_Corrupted,
  Pages_Corrupted,
  WPM_Typing_Speed,
  Bytes_Transferred_New
FROM `project-leducthinh-2024.DA04_K300.hack_data` 

-- Mean Squared Distance: 12399. >>> Chỉ số này thấp hơn nhiều so với k=2 >>> k=3 có chất lượng cụm tốt hơn.

-- Cụm 1: 84 phiên.
-- Cụm 2: 83 phiên.
-- Cụm 3: 167 phiên.
-- Hai cụm đầu có số lượng phiên gần bằng nhau, trong khi cụm thứ ba có nhiều phiên hơn hẳn.







-- Thử thêm với K=2 (Min-Max Scaling)
CREATE OR REPLACE MODEL `project-leducthinh-2024.DA04_K300.hack_data_clustering_mm_2`
OPTIONS(MODEL_TYPE = 'kmeans',
        num_clusters = 2) 
AS
SELECT 
  ML.MIN_MAX_SCALER(Session_Connection_Time) OVER() AS Session_Connection_Time_mm,
  ML.MIN_MAX_SCALER(Bytes_Transferred_New) OVER() AS Bytes_Transferred_New_mm,
  ML.MIN_MAX_SCALER(Kali_Trace_Used) OVER() AS Kali_Trace_Used_mm,
  ML.MIN_MAX_SCALER(Servers_Corrupted) OVER() AS Servers_Corrupted_mm,
  ML.MIN_MAX_SCALER(Pages_Corrupted) OVER() AS Pages_Corrupted_mm,
  ML.MIN_MAX_SCALER(WPM_Typing_Speed) OVER() AS WPM_Typing_Speed_mm
FROM `project-leducthinh-2024.DA04_K300.hack_data`;

-- K=3 (Min-Max Scaling)
CREATE OR REPLACE MODEL `project-leducthinh-2024.DA04_K300.hack_data_clustering_mm_3`
OPTIONS(MODEL_TYPE = 'kmeans',
        num_clusters = 3) 
AS
SELECT 
  ML.MIN_MAX_SCALER(Session_Connection_Time) OVER() AS Session_Connection_Time_mm,
  ML.MIN_MAX_SCALER(Bytes_Transferred_New) OVER() AS Bytes_Transferred_New_mm,
  ML.MIN_MAX_SCALER(Kali_Trace_Used) OVER() AS Kali_Trace_Used_mm,
  ML.MIN_MAX_SCALER(Servers_Corrupted) OVER() AS Servers_Corrupted_mm,
  ML.MIN_MAX_SCALER(Pages_Corrupted) OVER() AS Pages_Corrupted_mm,
  ML.MIN_MAX_SCALER(WPM_Typing_Speed) OVER() AS WPM_Typing_Speed_mm
FROM `project-leducthinh-2024.DA04_K300.hack_data`;




-- Chọn K=2:
-- Số lượng phiên trong mỗi cụm hoàn toàn đồng đều (167-167), phù hợp với yêu cầu đề bài rằng mỗi hacker phải thực hiện số lượng cuộc tấn công gần như bằng nhau.
-- Dữ liệu không thể hiện rõ ràng rằng cụm thứ ba ở K=3.
-- => Kết luận: Dựa trên yêu cầu "số lượng cuộc tấn công gần như bằng nhau", K=2 là phù hợp nhất. Điều này cho thấy chỉ có 2 hacker thực hiện các cuộc tấn công.



SELECT 
  CENTROID_ID, 
  Session_Connection_Time_mm, 
  Bytes_Transferred_New_mm, 
  Kali_Trace_Used_mm, 
  Servers_Corrupted_mm, 
  Pages_Corrupted_mm, 
  WPM_Typing_Speed_mm
FROM ML.PREDICT(
  MODEL `project-leducthinh-2024.DA04_K300.hack_data_clustering_mm_2`,
  (SELECT 
    ML.MIN_MAX_SCALER(Session_Connection_Time) OVER() AS Session_Connection_Time_mm,
    ML.MIN_MAX_SCALER(Bytes_Transferred_New) OVER() AS Bytes_Transferred_New_mm,
    ML.MIN_MAX_SCALER(Kali_Trace_Used) OVER() AS Kali_Trace_Used_mm,
    ML.MIN_MAX_SCALER(Servers_Corrupted) OVER() AS Servers_Corrupted_mm,
    ML.MIN_MAX_SCALER(Pages_Corrupted) OVER() AS Pages_Corrupted_mm,
    ML.MIN_MAX_SCALER(WPM_Typing_Speed) OVER() AS WPM_Typing_Speed_mm
  FROM `project-leducthinh-2024.DA04_K300.hack_data`)
);


-- Lưu csv results về + trực quan
-- Dự đoán cụm cho dữ liệu mới
SELECT *
FROM ML.PREDICT(
  MODEL `project-leducthinh-2024.DA04_K300.hack_data_clustering_mm_2`, 
  (
    SELECT 
      ML.MIN_MAX_SCALER(Session_Connection_Time) OVER() AS Session_Connection_Time_mm,
      ML.MIN_MAX_SCALER(Bytes_Transferred_New) OVER() AS Bytes_Transferred_New_mm,
      ML.MIN_MAX_SCALER(Kali_Trace_Used) OVER() AS Kali_Trace_Used_mm,
      ML.MIN_MAX_SCALER(Servers_Corrupted) OVER() AS Servers_Corrupted_mm,
      ML.MIN_MAX_SCALER(Pages_Corrupted) OVER() AS Pages_Corrupted_mm,
      ML.MIN_MAX_SCALER(WPM_Typing_Speed) OVER() AS WPM_Typing_Speed_mm,
      Session_Connection_Time,
      Bytes_Transferred_New,
      Kali_Trace_Used,
      Servers_Corrupted,
      Pages_Corrupted,
      WPM_Typing_Speed
    FROM (
      SELECT 30 AS Session_Connection_Time, 0.4 AS Bytes_Transferred_New, 1 AS Kali_Trace_Used, 
             6 AS Servers_Corrupted, 10 AS Pages_Corrupted, 60 AS WPM_Typing_Speed
      UNION ALL
      SELECT 20, 0.3, 0, 5, 8, 55
      UNION ALL
      SELECT 40, 0.6, 1, 7, 12, 50
    )
  )
);
